// ЁЯОп Speak EU - Advanced Language Learning Platform
// Main Application JavaScript

'use strict';

// ЁЯМН Global Configuration
const CONFIG = {
  APP_NAME: 'Speak EU',
  VERSION: '2.0.0',
  STORAGE_PREFIX: 'speak_eu_',
  
  // Learning Settings
  DAILY_TARGET: 15,
  STREAK_THRESHOLD: 24, // hours
  
  // Performance Settings
  LAZY_LOAD_THRESHOLD: 100,
  SEARCH_DEBOUNCE: 300,
  ANIMATION_DURATION: 300,
  
  // API Settings
  SPEECH_LANG_MAP: {
    'de': 'de-DE',
    'fr': 'fr-FR',
    'it': 'it-IT',
    'es': 'es-ES',
    'ru': 'ru-RU',
    'pl': 'pl-PL',
    'nl': 'nl-NL',
    'pt': 'pt-PT',
    'sv': 'sv-SE',
    'da': 'da-DK',
    'no': 'nb-NO',
    'fi': 'fi-FI',
    'el': 'el-GR',
    'cs': 'cs-CZ',
    'sk': 'sk-SK',
    'hu': 'hu-HU',
    'hr': 'hr-HR',
    'sl': 'sl-SI',
    'et': 'et-EE',
    'lv': 'lv-LV',
    'lt': 'lt-LT'
  }
};

// ЁЯЧ║я╕П Language Data Structure
const LANGUAGES = {
  // Schengen Countries
  germany: {
    code: 'de',
    name: 'ржЬрж╛рж░рзНржорж╛ржи',
    nativeName: 'Deutsch',
    country: 'ржЬрж╛рж░рзНржорж╛ржирж┐',
    flag: 'ЁЯЗйЁЯЗк',
    type: 'schengen',
    population: '83M',
    difficulty: 'intermediate',
    wordCount: 5284,
    categories: 22,
    priority: 'high'
  },
  france: {
    code: 'fr',
    name: 'ржлрж░рж╛рж╕рж┐',
    nativeName: 'Fran├зais',
    country: 'ржлрзНрж░рж╛ржирзНрж╕',
    flag: 'ЁЯЗлЁЯЗ╖',
    type: 'schengen',
    population: '68M',
    difficulty: 'intermediate',
    wordCount: 5156,
    categories: 22,
    priority: 'high'
  },
  italy: {
    code: 'it',
    name: 'ржЗрждрж╛рж▓рж┐ржпрж╝рж╛ржи',
    nativeName: 'Italiano',
    country: 'ржЗрждрж╛рж▓рж┐',
    flag: 'ЁЯЗоЁЯЗ╣',
    type: 'schengen',
    population: '60M',
    difficulty: 'beginner',
    wordCount: 4987,
    categories: 21,
    priority: 'high'
  },
  spain: {
    code: 'es',
    name: 'рж╕рзНржкрзНржпрж╛ржирж┐рж╢',
    nativeName: 'Espa├▒ol',
    country: 'рж╕рзНржкрзЗржи',
    flag: 'ЁЯЗкЁЯЗ╕',
    type: 'schengen',
    population: '47M',
    difficulty: 'beginner',
    wordCount: 5342,
    categories: 22,
    priority: 'high'
  },
  netherlands: {
    code: 'nl',
    name: 'ржбрж╛ржЪ',
    nativeName: 'Nederlands',
    country: 'ржирзЗржжрж╛рж░рж▓рзНржпрж╛ржирзНржбрж╕',
    flag: 'ЁЯЗ│ЁЯЗ▒',
    type: 'schengen',
    population: '17M',
    difficulty: 'intermediate',
    wordCount: 4723,
    categories: 20,
    priority: 'medium'
  },
  belgium: {
    code: 'nl',
    name: 'ржбрж╛ржЪ/ржлрж░рж╛рж╕рж┐',
    nativeName: 'Nederlands/Fran├зais',
    country: 'ржмрзЗрж▓ржЬрж┐ржпрж╝рж╛ржо',
    flag: 'ЁЯЗзЁЯЗк',
    type: 'schengen',
    population: '11M',
    difficulty: 'intermediate',
    wordCount: 4156,
    categories: 19,
    priority: 'medium'
  },
  austria: {
    code: 'de',
    name: 'ржЬрж╛рж░рзНржорж╛ржи',
    nativeName: 'Deutsch',
    country: 'ржЕрж╕рзНржЯрзНрж░рж┐ржпрж╝рж╛',
    flag: 'ЁЯЗжЁЯЗ╣',
    type: 'schengen',
    population: '9M',
    difficulty: 'intermediate',
    wordCount: 4892,
    categories: 21,
    priority: 'medium'
  },
  portugal: {
    code: 'pt',
    name: 'ржкрж░рзНрждрзБржЧрж┐ржЬ',
    nativeName: 'Portugu├кs',
    country: 'ржкрж░рзНрждрзБржЧрж╛рж▓',
    flag: 'ЁЯЗ╡ЁЯЗ╣',
    type: 'schengen',
    population: '10M',
    difficulty: 'intermediate',
    wordCount: 4567,
    categories: 20,
    priority: 'medium'
  },
  greece: {
    code: 'el',
    name: 'ржЧрзНрж░рж┐ржХ',
    nativeName: '╬Х╬╗╬╗╬╖╬╜╬╣╬║╬м',
    country: 'ржЧрзНрж░рж┐рж╕',
    flag: 'ЁЯЗмЁЯЗ╖',
    type: 'schengen',
    population: '11M',
    difficulty: 'advanced',
    wordCount: 3987,
    categories: 18,
    priority: 'medium'
  },
  sweden: {
    code: 'sv',
    name: 'рж╕рзБржЗржбрж┐рж╢',
    nativeName: 'Svenska',
    country: 'рж╕рзБржЗржбрзЗржи',
    flag: 'ЁЯЗ╕ЁЯЗк',
    type: 'schengen',
    population: '10M',
    difficulty: 'intermediate',
    wordCount: 4234,
    categories: 19,
    priority: 'medium'
  },
  norway: {
    code: 'no',
    name: 'ржирж░ржУржпрж╝рзЗржЬрж┐ржпрж╝рж╛ржи',
    nativeName: 'Norsk',
    country: 'ржирж░ржУржпрж╝рзЗ',
    flag: 'ЁЯЗ│ЁЯЗ┤',
    type: 'schengen',
    population: '5M',
    difficulty: 'intermediate',
    wordCount: 4156,
    categories: 19,
    priority: 'medium'
  },
  denmark: {
    code: 'da',
    name: 'ржбрзЗржирж┐рж╢',
    nativeName: 'Dansk',
    country: 'ржбрзЗржиржорж╛рж░рзНржХ',
    flag: 'ЁЯЗйЁЯЗ░',
    type: 'schengen',
    population: '6M',
    difficulty: 'intermediate',
    wordCount: 3987,
    categories: 18,
    priority: 'medium'
  },
  finland: {
    code: 'fi',
    name: 'ржлрж┐ржирж┐рж╢',
    nativeName: 'Suomi',
    country: 'ржлрж┐ржирж▓рзНржпрж╛ржирзНржб',
    flag: 'ЁЯЗлЁЯЗо',
    type: 'schengen',
    population: '6M',
    difficulty: 'advanced',
    wordCount: 3765,
    categories: 17,
    priority: 'low'
  },
  poland: {
    code: 'pl',
    name: 'ржкрзЛрж▓рж┐рж╢',
    nativeName: 'Polski',
    country: 'ржкрзЛрж▓рзНржпрж╛ржирзНржб',
    flag: 'ЁЯЗ╡ЁЯЗ▒',
    type: 'schengen',
    population: '38M',
    difficulty: 'advanced',
    wordCount: 4432,
    categories: 20,
    priority: 'high'
  },
  czechia: {
    code: 'cs',
    name: 'ржЪрзЗржХ',
    nativeName: '─Мe┼бtina',
    country: 'ржЪрзЗржХ ржкрзНрж░ржЬрж╛рждржирзНрждрзНрж░',
    flag: 'ЁЯЗиЁЯЗ┐',
    type: 'schengen',
    population: '11M',
    difficulty: 'advanced',
    wordCount: 3876,
    categories: 18,
    priority: 'medium'
  },
  slovakia: {
    code: 'sk',
    name: 'рж╕рзНрж▓рзЛржнрж╛ржХ',
    nativeName: 'Sloven─Нina',
    country: 'рж╕рзНрж▓рзЛржнрж╛ржХрж┐ржпрж╝рж╛',
    flag: 'ЁЯЗ╕ЁЯЗ░',
    type: 'schengen',
    population: '5M',
    difficulty: 'advanced',
    wordCount: 3654,
    categories: 17,
    priority: 'low'
  },
  hungary: {
    code: 'hu',
    name: 'рж╣рж╛ржЩрзНржЧрзЗрж░рж┐ржпрж╝рж╛ржи',
    nativeName: 'Magyar',
    country: 'рж╣рж╛ржЩрзНржЧрзЗрж░рж┐',
    flag: 'ЁЯЗнЁЯЗ║',
    type: 'schengen',
    population: '10M',
    difficulty: 'advanced',
    wordCount: 3543,
    categories: 16,
    priority: 'low'
  },
  slovenia: {
    code: 'sl',
    name: 'рж╕рзНрж▓рзЛржнрзЗржирж┐ржпрж╝рж╛ржи',
    nativeName: 'Sloven┼б─Нina',
    country: 'рж╕рзНрж▓рзЛржнрзЗржирж┐ржпрж╝рж╛',
    flag: 'ЁЯЗ╕ЁЯЗо',
    type: 'schengen',
    population: '2M',
    difficulty: 'advanced',
    wordCount: 3234,
    categories: 15,
    priority: 'low'
  },
  croatia: {
    code: 'hr',
    name: 'ржХрзНрж░рзЛржпрж╝рзЗрж╢рж┐ржпрж╝рж╛ржи',
    nativeName: 'Hrvatski',
    country: 'ржХрзНрж░рзЛржпрж╝рзЗрж╢рж┐ржпрж╝рж╛',
    flag: 'ЁЯЗнЁЯЗ╖',
    type: 'schengen',
    population: '4M',
    difficulty: 'advanced',
    wordCount: 3456,
    categories: 16,
    priority: 'low'
  },
  estonia: {
    code: 'et',
    name: 'ржПрж╕рзНрждрзЛржирж┐ржпрж╝рж╛ржи',
    nativeName: 'Eesti',
    country: 'ржПрж╕рзНрждрзЛржирж┐ржпрж╝рж╛',
    flag: 'ЁЯЗкЁЯЗк',
    type: 'schengen',
    population: '1M',
    difficulty: 'advanced',
    wordCount: 2987,
    categories: 14,
    priority: 'low'
  },
  latvia: {
    code: 'lv',
    name: 'рж▓рж╛ржЯржнрж┐ржпрж╝рж╛ржи',
    nativeName: 'Latvie┼бu',
    country: 'рж▓рж╛ржЯржнрж┐ржпрж╝рж╛',
    flag: 'ЁЯЗ▒ЁЯЗ╗',
    type: 'schengen',
    population: '2M',
    difficulty: 'advanced',
    wordCount: 3123,
    categories: 15,
    priority: 'low'
  },
  lithuania: {
    code: 'lt',
    name: 'рж▓рж┐ржерзБржпрж╝рж╛ржирж┐ржпрж╝рж╛ржи',
    nativeName: 'Lietuvi┼│',
    country: 'рж▓рж┐ржерзБржпрж╝рж╛ржирж┐ржпрж╝рж╛',
    flag: 'ЁЯЗ▒ЁЯЗ╣',
    type: 'schengen',
    population: '3M',
    difficulty: 'advanced',
    wordCount: 3234,
    categories: 15,
    priority: 'low'
  },
  luxembourg: {
    code: 'fr',
    name: 'ржлрж░рж╛рж╕рж┐/ржЬрж╛рж░рзНржорж╛ржи',
    nativeName: 'Fran├зais/Deutsch',
    country: 'рж▓рзБржХрзНрж╕рзЗржоржмрж╛рж░рзНржЧ',
    flag: 'ЁЯЗ▒ЁЯЗ║',
    type: 'schengen',
    population: '0.6M',
    difficulty: 'intermediate',
    wordCount: 2876,
    categories: 13,
    priority: 'low'
  },
  malta: {
    code: 'en',
    name: 'ржорж╛рж▓рзНржЯрж┐ржЬ/ржЗржВрж░рзЗржЬрж┐',
    nativeName: 'Malti/English',
    country: 'ржорж╛рж▓рзНржЯрж╛',
    flag: 'ЁЯЗ▓ЁЯЗ╣',
    type: 'schengen',
    population: '0.5M',
    difficulty: 'beginner',
    wordCount: 2456,
    categories: 12,
    priority: 'low'
  },
  cyprus: {
    code: 'el',
    name: 'ржЧрзНрж░рж┐ржХ',
    nativeName: '╬Х╬╗╬╗╬╖╬╜╬╣╬║╬м',
    country: 'рж╕рж╛ржЗржкрзНрж░рж╛рж╕',
    flag: 'ЁЯЗиЁЯЗ╛',
    type: 'schengen',
    population: '1M',
    difficulty: 'advanced',
    wordCount: 2789,
    categories: 13,
    priority: 'low'
  },
  iceland: {
    code: 'is',
    name: 'ржЖржЗрж╕рж▓рзНржпрж╛ржирзНржбрж┐ржХ',
    nativeName: '├Нslenska',
    country: 'ржЖржЗрж╕рж▓рзНржпрж╛ржирзНржб',
    flag: 'ЁЯЗоЁЯЗ╕',
    type: 'schengen',
    population: '0.4M',
    difficulty: 'advanced',
    wordCount: 2234,
    categories: 11,
    priority: 'low'
  },
  liechtenstein: {
    code: 'de',
    name: 'ржЬрж╛рж░рзНржорж╛ржи',
    nativeName: 'Deutsch',
    country: 'рж▓рж┐ржЪрзЗржирж╕рзНржЯрж╛ржЗржи',
    flag: 'ЁЯЗ▒ЁЯЗо',
    type: 'schengen',
    population: '0.04M',
    difficulty: 'intermediate',
    wordCount: 1987,
    categories: 10,
    priority: 'low'
  },
  
  // Non-Schengen
  russia: {
    code: 'ru',
    name: 'рж░рзБрж╢',
    nativeName: '╨а╤Г╤Б╤Б╨║╨╕╨╣',
    country: 'рж░рж╛рж╢рж┐ржпрж╝рж╛',
    flag: 'ЁЯЗ╖ЁЯЗ║',
    type: 'non-schengen',
    population: '146M',
    difficulty: 'advanced',
    wordCount: 5678,
    categories: 23,
    priority: 'high'
  }
};

// ЁЯУК Categories Configuration
const CATEGORIES = {
  daily: { name: 'ржжрзИржиржирзНржжрж┐ржи ржХржерзЛржкржХржержи', icon: 'ЁЯТм', priority: 1 },
  greetings: { name: 'рж╢рзБржнрзЗржЪрзНржЫрж╛ ржУ ржкрж░рж┐ржЪржпрж╝', icon: 'ЁЯСЛ', priority: 2 },
  numbers: { name: 'рж╕ржВржЦрзНржпрж╛ ржУ рж╕ржоржпрж╝', icon: 'ЁЯФв', priority: 3 },
  food: { name: 'ржЦрж╛ржмрж╛рж░ ржУ ржкрж╛ржирзАржпрж╝', icon: 'ЁЯН╜я╕П', priority: 4 },
  travel: { name: 'ржнрзНрж░ржоржг ржУ ржкрж░рж┐ржмрж╣ржи', icon: 'тЬИя╕П', priority: 5 },
  accommodation: { name: 'ржерж╛ржХрж╛рж░ ржмрзНржпржмрж╕рзНржерж╛', icon: 'ЁЯПи', priority: 6 },
  work: { name: 'ржХрж╛ржЬ ржУ ржкрзЗрж╢рж╛', icon: 'ЁЯТ╝', priority: 7 },
  education: { name: 'рж╢рж┐ржХрзНрж╖рж╛ ржУ ржмрж┐рж╢рзНржмржмрж┐ржжрзНржпрж╛рж▓ржпрж╝', icon: 'ЁЯОУ', priority: 8 },
  health: { name: 'рж╕рзНржмрж╛рж╕рзНржерзНржп ржУ ржЪрж┐ржХрж┐рзОрж╕рж╛', icon: 'ЁЯПе', priority: 9 },
  emergency: { name: 'ржЬрж░рзБрж░рж┐ ржЕржмрж╕рзНржерж╛', icon: 'ЁЯЪи', priority: 10 },
  shopping: { name: 'ржХрзЗржирж╛ржХрж╛ржЯрж╛ ржУ ржмрж╛ржЬрж╛рж░', icon: 'ЁЯЫНя╕П', priority: 11 },
  banking: { name: 'ржмрзНржпрж╛ржВржХрж┐ржВ ржУ ржЖрж░рзНржерж┐ржХ', icon: 'ЁЯПж', priority: 12 },
  government: { name: 'рж╕рж░ржХрж╛рж░рж┐ ржХрж╛ржЬ', icon: 'ЁЯПЫя╕П', priority: 13 },
  legal: { name: 'ржЖржЗржирж┐ ржмрж┐рж╖ржпрж╝', icon: 'тЪЦя╕П', priority: 14 },
  technology: { name: 'ржкрзНрж░ржпрзБржХрзНрждрж┐ ржУ ржЗржирзНржЯрж╛рж░ржирзЗржЯ', icon: 'ЁЯТ╗', priority: 15 },
  weather: { name: 'ржЖржмрж╣рж╛ржУржпрж╝рж╛ ржУ ржкрзНрж░ржХрзГрждрж┐', icon: 'ЁЯМдя╕П', priority: 16 },
  family: { name: 'ржкрж░рж┐ржмрж╛рж░ ржУ рж╕ржорзНржкрж░рзНржХ', icon: 'ЁЯСитАНЁЯСйтАНЁЯСзтАНЁЯСж', priority: 17 },
  hobbies: { name: 'рж╢ржЦ ржУ ржмрж┐ржирзЛржжржи', icon: 'ЁЯОо', priority: 18 },
  sports: { name: 'ржЦрзЗрж▓рж╛ржзрзБрж▓рж╛ ржУ ржмрзНржпрж╛ржпрж╝рж╛ржо', icon: 'тЪ╜', priority: 19 },
  culture: { name: 'рж╕ржВрж╕рзНржХрзГрждрж┐ ржУ ржРрждрж┐рж╣рзНржп', icon: 'ЁЯОн', priority: 20 },
  directions: { name: 'ржжрж┐ржХржирж┐рж░рзНржжрзЗрж╢ржирж╛', icon: 'ЁЯзн', priority: 21 },
  clothing: { name: 'ржкрзЛрж╢рж╛ржХ ржУ ржлрзНржпрж╛рж╢ржи', icon: 'ЁЯСХ', priority: 22 },
  body: { name: 'рж╢рж░рзАрж░ ржУ ржЕржЩрзНржЧржкрзНрж░рждрзНржпржЩрзНржЧ', icon: 'ЁЯзСтАНтЪХя╕П', priority: 23 }
};

// ЁЯОп Application State
class AppState {
  constructor() {
    this.currentLanguage = null;
    this.currentSection = 'home';
    this.vocabularyData = new Map();
    this.userProgress = new Map();
    this.favorites = new Set();
    this.searchResults = [];
    this.filters = {
      category: 'all',
      difficulty: 'all',
      type: 'all'
    };
    this.settings = {
      theme: 'light',
      autoPlay: true,
      speechRate: 1,
      fontSize: 'medium',
      notifications: true
    };
    this.isLoading = false;
    this.loadProgress = 0;
  }

  // ЁЯТ╛ Storage Methods
  save() {
    try {
      localStorage.setItem(CONFIG.STORAGE_PREFIX + 'state', JSON.stringify({
        currentLanguage: this.currentLanguage,
        userProgress: Array.from(this.userProgress.entries()),
        favorites: Array.from(this.favorites),
        settings: this.settings,
        filters: this.filters
      }));
    } catch (error) {
      console.error('Failed to save state:', error);
    }
  }

  load() {
    try {
      const saved = localStorage.getItem(CONFIG.STORAGE_PREFIX + 'state');
      if (saved) {
        const data = JSON.parse(saved);
        this.currentLanguage = data.currentLanguage;
        this.userProgress = new Map(data.userProgress || []);
        this.favorites = new Set(data.favorites || []);
        this.settings = { ...this.settings, ...data.settings };
        this.filters = { ...this.filters, ...data.filters };
      }
    } catch (error) {
      console.error('Failed to load state:', error);
    }
  }

  // ЁЯУК Progress Methods
  getTodayProgress(language = null) {
    const lang = language || this.currentLanguage;
    const today = new Date().toDateString();
    const key = `${lang}_${today}`;
    return this.userProgress.get(key) || { learned: 0, target: CONFIG.DAILY_TARGET };
  }

  updateProgress(language, increment = 1) {
    const today = new Date().toDateString();
    const key = `${language}_${today}`;
    const current = this.getTodayProgress(language);
    current.learned += increment;
    this.userProgress.set(key, current);
    this.save();
    this.notifyProgressUpdate(language, current);
  }

  getStreak(language = null) {
    const lang = language || this.currentLanguage;
    let streak = 0;
    let currentDate = new Date();
    
    while (true) {
      const dateStr = currentDate.toDateString();
      const key = `${lang}_${dateStr}`;
      const progress = this.userProgress.get(key);
      
      if (progress && progress.learned > 0) {
        streak++;
        currentDate.setDate(currentDate.getDate() - 1);
      } else {
        break;
      }
    }
    
    return streak;
  }

  getTotalLearned(language = null) {
    const lang = language || this.currentLanguage;
    let total = 0;
    for (const [key, progress] of this.userProgress) {
      if (key.startsWith(lang + '_')) {
        total += progress.learned;
      }
    }
    return total;
  }

  notifyProgressUpdate(language, progress) {
    const event = new CustomEvent('progressUpdate', {
      detail: { language, progress, streak: this.getStreak(language) }
    });
    document.dispatchEvent(event);
  }
}

// ЁЯОп Core Application Class
class SpeakEU {
  constructor() {
    this.state = new AppState();
    this.speechSynth = window.speechSynthesis;
    this.recognition = null;
    this.currentAudio = null;
    this.searchTimeout = null;
    this.intersectionObserver = null;
    
    // Bind methods
    this.handleResize = this.handleResize.bind(this);
    this.handleScroll = this.handleScroll.bind(this);
    this.handleKeyboard = this.handleKeyboard.bind(this);
    this.handleVisibilityChange = this.handleVisibilityChange.bind(this);
  }

  // ЁЯЪА Initialization
  async init() {
    try {
      console.log('ЁЯЪА Initializing Speak EU...');
      
      // Load saved state
      this.state.load();
      
      // Initialize components
      await this.initializeComponents();
      
      // Setup event listeners
      this.setupEventListeners();
      
      // Apply saved settings
      this.applySettings();
      
      // Start loading process
      await this.startLoadingProcess();
      
      // Initialize PWA features
      this.initializePWA();
      
      console.log('тЬЕ Speak EU initialized successfully');
      
    } catch (error) {
      console.error('тЭМ Failed to initialize app:', error);
      this.showError('ржЕрзНржпрж╛ржк рж▓рзЛржб ржХрж░рждрзЗ рж╕ржорж╕рзНржпрж╛ рж╣ржпрж╝рзЗржЫрзЗред ржкрзЗржЬ рж░рж┐ржлрзНрж░рзЗрж╢ ржХрж░рзБржиред');
    }
  }

  async initializeComponents() {
    // Initialize UI components
    this.initializeNavigation();
    this.initializeSearch();
    this.initializeThemeToggle();
    this.initializeMobileMenu();
    this.initializeLanguageSelector();
    this.initializeIntersectionObserver();
    
    // Load initial data
    await this.loadInitialData();
  }

  async startLoadingProcess() {
    const loadingScreen = document.getElementById('loadingScreen');
    const progressFill = document.getElementById('loadingProgress');
    const progressText = document.getElementById('loadingPercentage');
    
    const steps = [
      { name: 'ржерж┐ржо рж▓рзЛржб рж╣ржЪрзНржЫрзЗ...', duration: 200 },
      { name: 'ржнрж╛рж╖рж╛рж░ ржбрзЗржЯрж╛ ржкрзНрж░рж╕рзНрждрзБржд ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ...', duration: 500 },
      { name: 'UI ржХржорзНржкрзЛржирзЗржирзНржЯ рж╕рзЗржЯржЖржк...', duration: 300 },
      { name: 'ржЕржбрж┐ржУ рж╕рж┐рж╕рзНржЯрзЗржо ржЪрзЗржХ...', duration: 400 },
      { name: 'ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзАрж░ ржбрзЗржЯрж╛ рж▓рзЛржб...', duration: 200 },
      { name: 'ржЪрзВржбрж╝рж╛ржирзНржд ржкрзНрж░рж╕рзНрждрзБрждрж┐...', duration: 300 }
    ];
    
    let currentProgress = 0;
    const totalSteps = steps.length;
    
    for (let i = 0; i < totalSteps; i++) {
      const step = steps[i];
      document.querySelector('.loading-text').textContent = step.name;
      
      // Animate progress
      const targetProgress = ((i + 1) / totalSteps) * 100;
      await this.animateProgress(progressFill, progressText, currentProgress, targetProgress);
      currentProgress = targetProgress;
      
      // Wait for step duration
      await this.delay(step.duration);
    }
    
    // Hide loading screen
    await this.delay(200);
    loadingScreen.classList.add('hidden');
    document.body.setAttribute('data-loading', 'false');
    
    // Show main content with animation
    this.showMainContent();
  }

  async animateProgress(progressFill, progressText, start, end) {
    return new Promise(resolve => {
      const duration = 200;
      const startTime = performance.now();
      
      const animate = (currentTime) => {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        const currentValue = start + (end - start) * progress;
        progressFill.style.width = `${currentValue}%`;
        progressText.textContent = `${Math.round(currentValue)}%`;
        
        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {
          resolve();
        }
      };
      
      requestAnimationFrame(animate);
    });
  }

  showMainContent() {
    const mainContent = document.getElementById('mainContent');
    mainContent.classList.add('animate-fadeInUp');
    
    // Animate homepage elements
    this.animateHomepageElements();
  }

  animateHomepageElements() {
    const elements = document.querySelectorAll('.hero-section, .quick-access, .popular-languages, .learning-paths');
    elements.forEach((element, index) => {
      setTimeout(() => {
        element.classList.add('animate-fadeInUp');
      }, index * 100);
    });
  }

  // ЁЯОп Navigation System
  initializeNavigation() {
    const navItems = document.querySelectorAll('.nav-item, .mobile-nav-item');
    
    navItems.forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const section = item.getAttribute('data-section');
        this.navigateToSection(section);
      });
    });
    
    // Handle browser back/forward
    window.addEventListener('popstate', (e) => {
      const section = e.state?.section || 'home';
      this.navigateToSection(section, false);
    });
  }

  navigateToSection(section, pushState = true) {
    // Update URL
    if (pushState) {
      history.pushState({ section }, '', `#${section}`);
    }
    
    // Update navigation
    this.updateActiveNavigation(section);
    
    // Show section
    this.showSection(section);
    
    // Update state
    this.state.currentSection = section;
    this.state.save();
    
    // Close mobile menu if open
    this.closeMobileMenu();
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  updateActiveNavigation(section) {
    const allNavItems = document.querySelectorAll('.nav-item, .mobile-nav-item');
    allNavItems.forEach(item => {
      item.classList.toggle('active', item.getAttribute('data-section') === section);
    });
  }

  showSection(section) {
    const allSections = document.querySelectorAll('.content-section');
    allSections.forEach(sec => {
      sec.classList.remove('active');
    });
    
    const targetSection = document.getElementById(`${section}Section`);
    if (targetSection) {
      targetSection.classList.add('active');
      targetSection.classList.add('animate-fadeIn');
      
      // Load section-specific content
      this.loadSectionContent(section);
    }
  }

  async loadSectionContent(section) {
    switch (section) {
      case 'home':
        this.loadHomepageContent();
        break;
      case 'languages':
        this.loadLanguagesContent();
        break;
      case 'learn':
        this.loadLearningContent();
        break;
      case 'progress':
        this.loadProgressContent();
        break;
    }
  }

  // ЁЯПа Homepage Content
  loadHomepageContent() {
    this.loadPopularLanguages();
    this.setupQuickAccess();
    this.setupLearningPaths();
    this.updateHomepageStats();
  }

  loadPopularLanguages() {
    const container = document.getElementById('popularLanguagesGrid');
    if (!container) return;
    
    const popularLanguages = Object.entries(LANGUAGES)
      .filter(([_, lang]) => lang.priority === 'high')
      .slice(0, 6);
    
    container.innerHTML = popularLanguages.map(([key, lang]) => 
      this.createLanguageCard(key, lang, 'compact')
    ).join('');
    
    // Add stagger animation
    container.classList.add('stagger-children');
  }

  createLanguageCard(key, lang, variant = 'full') {
    const progress = this.state.getTodayProgress(key);
    const totalLearned = this.state.getTotalLearned(key);
    const streak = this.state.getStreak(key);
    
    const compactClass = variant === 'compact' ? 'language-card-compact' : '';
    
    return `
      <div class="language-card ${compactClass} grid-animate" data-language="${key}">
        <div class="language-header">
          <span class="language-flag">${lang.flag}</span>
          <span class="language-type">${lang.type === 'schengen' ? 'рж╢рзЗржиржЬрзЗржи' : 'ржиржи-рж╢рзЗржиржЬрзЗржи'}</span>
        </div>
        <div class="language-content">
          <h3 class="language-name">${lang.name}</h3>
          <p class="language-info">${lang.country} тАв ${lang.population} ржЬржирж╕ржВржЦрзНржпрж╛</p>
          <div class="language-stats">
            <div class="language-stat">
              <span class="stat-number">${lang.wordCount.toLocaleString()}</span>
              <span class="stat-label">рж╢ржмрзНржж</span>
            </div>
            <div class="language-stat">
              <span class="stat-number">${lang.categories}</span>
              <span class="stat-label">ржХрзНржпрж╛ржЯрж╛ржЧрж░рж┐</span>
            </div>
            <div class="language-stat">
              <span class="stat-number">${totalLearned}</span>
              <span class="stat-label">рж╢рж┐ржЦрзЗржЫрж┐</span>
            </div>
          </div>
          ${variant === 'full' ? `
            <div class="language-progress">
              <div class="progress-info">
                <span>ржЖржЬржХрзЗрж░ ржЕржЧрзНрж░ржЧрждрж┐: ${progress.learned}/${progress.target}</span>
                <span>${Math.round((progress.learned / progress.target) * 100)}%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${Math.min((progress.learned / progress.target) * 100, 100)}%"></div>
              </div>
            </div>
          ` : ''}
          <div class="language-actions">
            <button class="btn btn-primary btn-small" onclick="app.selectLanguage('${key}')">
              <span class="btn-icon">ЁЯЪА</span>
              <span>рж╢рзБрж░рзБ ржХрж░рзБржи</span>
            </button>
            ${variant === 'full' ? `
              <button class="btn btn-outline btn-small" onclick="app.showLanguageDetails('${key}')">
                <span class="btn-icon">тД╣я╕П</span>
                <span>ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд</span>
              </button>
            ` : ''}
          </div>
        </div>
      </div>
    `;
  }

  setupQuickAccess() {
    const quickCards = document.querySelectorAll('.quick-card');
    quickCards.forEach(card => {
      card.addEventListener('click', () => {
        const action = card.getAttribute('data-action');
        this.handleQuickAction(action);
      });
    });
  }

  handleQuickAction(action) {
    switch (action) {
      case 'emergency':
        this.showEmergencyPhrases();
        break;
      case 'daily':
        this.showDailyConversation();
        break;
      case 'work':
        this.showWorkplacePhrases();
        break;
      case 'travel':
        this.showTravelPhrases();
        break;
    }
  }

  setupLearningPaths() {
    const pathCards = document.querySelectorAll('.path-card');
    pathCards.forEach(card => {
      card.addEventListener('click', () => {
        const path = card.getAttribute('data-path');
        this.startLearningPath(path);
      });
    });
  }

  startLearningPath(path) {
    // Store selected path
    this.state.selectedPath = path;
    this.state.save();
    
    // Navigate to languages section with path filter
    this.navigateToSection('languages');
    
    // Show toast
    this.showToast(`${path === 'student' ? 'рж╕рзНржЯрзБржбрзЗржирзНржЯ' : path === 'worker' ? 'ржУржпрж╝рж╛рж░рзНржХрж╛рж░' : 'ржЯрзНржпрзБрж░рж┐рж╕рзНржЯ'} ржкрж╛рже ржирж┐рж░рзНржмрж╛ржЪрж┐ржд рж╣ржпрж╝рзЗржЫрзЗ`, 'success');
  }

  updateHomepageStats() {
    const totalLanguages = Object.keys(LANGUAGES).length;
    const totalWords = Object.values(LANGUAGES).reduce((sum, lang) => sum + lang.wordCount, 0);
    const totalCategories = Object.keys(CATEGORIES).length;
    
    // Update stats in hero section
    const statCards = document.querySelectorAll('.stat-card');
    if (statCards.length >= 3) {
      statCards[0].querySelector('.stat-number').textContent = totalLanguages;
      statCards[1].querySelector('.stat-number').textContent = `${Math.round(totalWords / 1000)}K+`;
      statCards[2].querySelector('.stat-number').textContent = `${totalCategories}+`;
    }
  }

  // ЁЯМН Languages Content
  loadLanguagesContent() {
    this.setupLanguageFilter();
    this.renderLanguagesGrid();
    this.updateLanguageStats();
  }

  setupLanguageFilter() {
    const filterTabs = document.querySelectorAll('.filter-tab');
    const searchInput = document.getElementById('languageSearchInput');
    
    filterTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const filter = tab.getAttribute('data-filter');
        this.applyLanguageFilter(filter);
        
        // Update active tab
        filterTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
      });
    });
    
    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(() => {
          this.searchLanguages(e.target.value);
        }, CONFIG.SEARCH_DEBOUNCE);
      });
    }
  }

  applyLanguageFilter(filter) {
    this.state.filters.type = filter;
    this.renderLanguagesGrid();
  }

  searchLanguages(query) {
    const filteredLanguages = Object.entries(LANGUAGES).filter(([key, lang]) => {
      const searchText = query.toLowerCase();
      return lang.name.toLowerCase().includes(searchText) ||
             lang.country.toLowerCase().includes(searchText) ||
             lang.nativeName.toLowerCase().includes(searchText);
    });
    
    this.renderLanguagesGrid(filteredLanguages);
  }

  renderLanguagesGrid(filteredData = null) {
    const container = document.getElementById('languagesGrid');
    if (!container) return;
    
    let languagesToShow = filteredData || Object.entries(LANGUAGES);
    
    // Apply type filter
    if (this.state.filters.type !== 'all') {
      languagesToShow = languagesToShow.filter(([_, lang]) => {
        if (this.state.filters.type === 'schengen') return lang.type === 'schengen';
        if (this.state.filters.type === 'non-schengen') return lang.type === 'non-schengen';
        if (this.state.filters.type === 'popular') return lang.priority === 'high';
        return true;
      });
    }
    
    // Sort by priority and name
    languagesToShow.sort((a, b) => {
      const priorityOrder = { high: 0, medium: 1, low: 2 };
      const aPriority = priorityOrder[a[1].priority] || 3;
      const bPriority = priorityOrder[b[1].priority] || 3;
      
      if (aPriority !== bPriority) return aPriority - bPriority;
      return a[1].name.localeCompare(b[1].name);
    });
    
    container.innerHTML = languagesToShow.map(([key, lang]) => 
      this.createLanguageCard(key, lang, 'full')
    ).join('');
    
    // Add grid animation
    container.classList.add('stagger-children');
    
    // Update counts in filter tabs
    this.updateFilterCounts();
  }

  updateFilterCounts() {
    const tabs = document.querySelectorAll('.filter-tab');
    tabs.forEach(tab => {
      const filter = tab.getAttribute('data-filter');
      let count = 0;
      
      switch (filter) {
        case 'all':
          count = Object.keys(LANGUAGES).length;
          break;
        case 'schengen':
          count = Object.values(LANGUAGES).filter(lang => lang.type === 'schengen').length;
          break;
        case 'non-schengen':
          count = Object.values(LANGUAGES).filter(lang => lang.type === 'non-schengen').length;
          break;
        case 'popular':
          count = Object.values(LANGUAGES).filter(lang => lang.priority === 'high').length;
          break;
      }
      
      const countElement = tab.querySelector('.tab-count');
      if (countElement) {
        countElement.textContent = count;
      }
    });
  }

  // ЁЯОп Language Selection
  selectLanguage(languageKey) {
    this.state.currentLanguage = languageKey;
    this.state.save();
    
    // Navigate to learn section
    this.navigateToSection('learn');
    
    // Show success message
    const language = LANGUAGES[languageKey];
    this.showToast(`${language.name} ржнрж╛рж╖рж╛ ржирж┐рж░рзНржмрж╛ржЪрж┐ржд рж╣ржпрж╝рзЗржЫрзЗ`, 'success');
  }

  showLanguageDetails(languageKey) {
    const language = LANGUAGES[languageKey];
    // Implement language details modal
    this.showModal('languageDetails', { language, key: languageKey });
  }

  // ЁЯФН Search System
  initializeSearch() {
    const searchToggle = document.getElementById('searchToggle');
    const globalSearch = document.getElementById('globalSearch');
    const searchInput = document.getElementById('globalSearchInput');
    const searchClose = document.getElementById('searchClose');
    const searchBtn = document.getElementById('globalSearchBtn');
    
    if (searchToggle) {
      searchToggle.addEventListener('click', () => {
        globalSearch.classList.toggle('hidden');
        if (!globalSearch.classList.contains('hidden')) {
          searchInput.focus();
        }
      });
    }
    
    if (searchClose) {
      searchClose.addEventListener('click', () => {
        globalSearch.classList.add('hidden');
        searchInput.value = '';
      });
    }
    
    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(() => {
          this.performGlobalSearch(e.target.value);
        }, CONFIG.SEARCH_DEBOUNCE);
      });
      
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          this.performGlobalSearch(e.target.value);
        }
        if (e.key === 'Escape') {
          globalSearch.classList.add('hidden');
        }
      });
    }
    
    if (searchBtn) {
      searchBtn.addEventListener('click', () => {
        this.performGlobalSearch(searchInput.value);
      });
    }
  }

  async performGlobalSearch(query) {
    if (!query.trim()) return;
    
    this.showSearchSuggestions([]);
    
    const results = await this.searchAcrossLanguages(query);
    this.showSearchSuggestions(results);
  }

  async searchAcrossLanguages(query) {
    const results = [];
    const searchTerm = query.toLowerCase().trim();
    
    for (const [langKey, language] of Object.entries(LANGUAGES)) {
      try {
        const vocabularyData = await this.loadLanguageData(langKey);
        
        const matches = vocabularyData.filter(item => {
          return item.bn && item.bn.toLowerCase().includes(searchTerm) ||
                 item.bnMeaning && item.bnMeaning.toLowerCase().includes(searchTerm) ||
                 item.en && item.en.toLowerCase().includes(searchTerm) ||
                 (item[language.code] && item[language.code].toLowerCase().includes(searchTerm));
        });
        
        matches.forEach(match => {
          results.push({
            ...match,
            language: langKey,
            languageName: language.name,
            flag: language.flag
          });
        });
        
      } catch (error) {
        console.warn(`Failed to search in ${langKey}:`, error);
      }
    }
    
    return results.slice(0, 10); // Limit results
  }

  showSearchSuggestions(results) {
    const container = document.getElementById('searchSuggestions');
    if (!container) return;
    
    if (results.length === 0) {
      container.innerHTML = '<div class="search-no-results">ржХрзЛржирзЛ ржлрж▓рж╛ржлрж▓ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐</div>';
      return;
    }
    
    container.innerHTML = results.map(result => `
      <div class="search-suggestion" onclick="app.selectSearchResult('${result.language}', ${JSON.stringify(result).replace(/"/g, '&quot;')})">
        <div class="suggestion-header">
          <span class="suggestion-flag">${result.flag}</span>
          <span class="suggestion-language">${result.languageName}</span>
        </div>
        <div class="suggestion-content">
          <div class="suggestion-phrase">${result[LANGUAGES[result.language].code] || ''}</div>
          <div class="suggestion-meaning">${result.bnMeaning || result.bn || ''}</div>
        </div>
      </div>
    `).join('');
  }

  selectSearchResult(languageKey, result) {
    // Close search
    document.getElementById('globalSearch').classList.add('hidden');
    
    // Select language and navigate
    this.selectLanguage(languageKey);
    
    // Highlight the selected phrase in learning interface
    setTimeout(() => {
      this.highlightPhrase(result);
    }, 1000);
  }

  // ЁЯОи Theme System
  initializeThemeToggle() {
    const themeToggle = document.getElementById('themeToggle');
    
    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        this.toggleTheme();
      });
    }
    
    // Set initial theme
    this.applyTheme(this.state.settings.theme);
  }

  toggleTheme() {
    const newTheme = this.state.settings.theme === 'light' ? 'dark' : 'light';
    this.state.settings.theme = newTheme;
    this.state.save();
    this.applyTheme(newTheme);
  }

  applyTheme(theme) {
    document.body.className = document.body.className.replace(/\b(light|dark)-theme\b/g, '');
    document.body.classList.add(`${theme}-theme`);
    
    // Update theme toggle icon
    const themeToggle = document.getElementById('themeToggle');
    if (themeToggle) {
      const icon = themeToggle.querySelector('.btn-icon');
      icon.textContent = theme === 'light' ? 'ЁЯМЩ' : 'тШАя╕П';
    }
    
    // Update meta theme color
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    if (metaTheme) {
      metaTheme.content = theme === 'light' ? '#2563eb' : '#1e293b';
    }
  }

  // ЁЯУ▒ Mobile Menu
  initializeMobileMenu() {
    const menuBtn = document.getElementById('mobileMenuBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    const menuClose = document.getElementById('mobileMenuClose');
    const overlay = mobileMenu?.querySelector('.mobile-menu-overlay');
    
    if (menuBtn && mobileMenu) {
      menuBtn.addEventListener('click', () => {
        this.openMobileMenu();
      });
    }
    
    if (menuClose) {
      menuClose.addEventListener('click', () => {
        this.closeMobileMenu();
      });
    }
    
    if (overlay) {
      overlay.addEventListener('click', () => {
        this.closeMobileMenu();
      });
    }
  }

  openMobileMenu() {
    const mobileMenu = document.getElementById('mobileMenu');
    if (mobileMenu) {
      mobileMenu.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      
      // Update mobile stats
      this.updateMobileMenuStats();
    }
  }

  closeMobileMenu() {
    const mobileMenu = document.getElementById('mobileMenu');
    if (mobileMenu) {
      mobileMenu.classList.add('hidden');
      document.body.style.overflow = '';
    }
  }

  updateMobileMenuStats() {
    const wordsElement = document.getElementById('mobileStatsWords');
    const streakElement = document.getElementById('mobileStatsStreak');
    
    if (wordsElement && this.state.currentLanguage) {
      const total = this.state.getTotalLearned(this.state.currentLanguage);
      wordsElement.textContent = total;
    }
    
    if (streakElement && this.state.currentLanguage) {
      const streak = this.state.getStreak(this.state.currentLanguage);
      streakElement.textContent = streak;
    }
  }

  // ЁЯО╡ Audio System
  async playAudio(text, languageCode) {
    try {
      // Stop any current audio
      if (this.currentAudio) {
        this.speechSynth.cancel();
      }
      
      // Create speech synthesis utterance
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = CONFIG.SPEECH_LANG_MAP[languageCode] || languageCode;
      utterance.rate = this.state.settings.speechRate;
      utterance.volume = 1;
      
      // Get available voices
      const voices = this.speechSynth.getVoices();
      const voice = voices.find(v => v.lang.startsWith(utterance.lang.substring(0, 2)));
      if (voice) {
        utterance.voice = voice;
      }
      
      // Speak
      this.speechSynth.speak(utterance);
      this.currentAudio = utterance;
      
      return new Promise((resolve) => {
        utterance.onend = resolve;
        utterance.onerror = resolve;
      });
      
    } catch (error) {
      console.warn('Audio playback failed:', error);
    }
  }

  // ЁЯТ╛ Data Loading
  async loadLanguageData(languageKey) {
    if (this.state.vocabularyData.has(languageKey)) {
      return this.state.vocabularyData.get(languageKey);
    }
    
    try {
      // In a real implementation, this would load from JSON files
      // For now, we'll return sample data
      const sampleData = await this.generateSampleData(languageKey);
      this.state.vocabularyData.set(languageKey, sampleData);
      return sampleData;
    } catch (error) {
      console.error(`Failed to load data for ${languageKey}:`, error);
      return [];
